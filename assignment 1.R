##=====================================================================================================================================================================================================##
#   Assignment 1
##=====================================================================================================================================================================================================##

##=====================================================================================================================================================================================================##
#   Loading packages
##=====================================================================================================================================================================================================##

library(psych)
library(dplyr)
library(lm.beta) 
library(tidyverse) 
library(lmtest)
library(car) 
library(sandwich) 

##=====================================================================================================================================================================================================##
#   Custom functions from the seminars
##=====================================================================================================================================================================================================##

error_plotter <- function(mod, col = "black", x_var = NULL){
  mod_vars = as.character(mod$call[2])
  data = as.data.frame(eval(parse(text = as.character(mod$call[3]))))
  y = substr(mod_vars, 1, as.numeric(gregexpr(pattern ='~',mod_vars))-2)
  x = substr(mod_vars, as.numeric(gregexpr(pattern ='~',mod_vars))+2, nchar(mod_vars))
  data$pred = predict(mod)
  if(x == "1" & is.null(x_var)){x = "response_ID"
  data$response_ID = 1:nrow(data)} else if(x == "1"){x = x_var}
  plot(data[,y] ~ data[,x], ylab = y, xlab = x)
  abline(mod)
  for(i in 1:nrow(data)){
    clip(min(data[,x]), max(data[,x]), min(data[i,c(y,"pred")]), max(data[i,c(y,"pred")]))
    abline(v = data[i,x], lty = 2, col = col)
  }
}

coef_table = function(model) {
  require(lm.beta)
  mod_sum = summary(model)
  mod_sum_p_values = as.character(round(mod_sum$coefficients[,
                                                             4], 3))
  mod_sum_p_values[mod_sum_p_values != "0" & mod_sum_p_values !=
                     "1"] = substr(mod_sum_p_values[mod_sum_p_values != "0" &
                                                      mod_sum_p_values != "1"], 2, nchar(mod_sum_p_values[mod_sum_p_values !=
                                                                                                            "0" & mod_sum_p_values != "1"]))
  mod_sum_p_values[mod_sum_p_values == "0"] = "<.001"
  mod_sum_table = cbind(as.data.frame(round(cbind(coef(model),
                                                  confint(model), c(0, lm.beta(model)$standardized.coefficients[c(2:length(model$coefficients))])),
                                            2)), mod_sum_p_values)
  names(mod_sum_table) = c("b", "95%CI lb", "95%CI ub", "Std.Beta",
                           "p-value")
  mod_sum_table["(Intercept)", "Std.Beta"] = "0"
  return(mod_sum_table)
}

##=====================================================================================================================================================================================================##
#   Screening the data through plots and eyeballing
##=====================================================================================================================================================================================================##

data_sample_1 = read.csv("https://tinyurl.com/ha-dataset1")
View(data_sample_1)

data_sample_1 %>% 
  summary()

describe(data_sample_1)

data_sample_1 %>% 
  ggplot() +
  aes(x = age, fill = sex) +
  geom_histogram()

data_sample_1 %>% 
  ggplot() +
  aes(x = STAI_trait, fill = sex) +
  geom_histogram()

data_sample_1 <- data_sample_1[-c(93, 109, 150),] # excluding participants

data_sample_1 %>%
  ggplot() +
  aes(y = pain, x = age) +
  geom_point(aes(color = sex), size = 4) +
  geom_smooth()

data_sample_1 <- data_sample_1 %>% # changing sex into a factor
  mutate(sex = factor(sex))

##=====================================================================================================================================================================================================##
#   Building the two models
##=====================================================================================================================================================================================================##

mod_1 = lm(pain ~ age + sex, data = data_sample_1) 
mod_1 %>% 
  summary()

mod_2 = lm(pain ~ age + sex + STAI_trait + pain_cat + mindfulness + cortisol_serum + cortisol_saliva, data = data_sample_1)
mod_2 %>% 
  summary()

##=====================================================================================================================================================================================================##
#  Checking for outliers for mod_2
##=====================================================================================================================================================================================================##

mod_2 %>% plot(which = 5) # Residuals vs Leverage
mod_2 %>% plot(which = 4) # Cook's distance

# Checking for high values to ensure they are valid data and not errors.
data_sample_1 %>% slice(c(112, 99, 68)) 

##=====================================================================================================================================================================================================##
#  Checking normality
##=====================================================================================================================================================================================================##

mod_2 %>% plot(which = 2) # QQ plot

residuals_mod_2 = enframe(residuals(mod_2))
residuals_mod_2 %>%        
  ggplot() + aes(x = value) + 
  geom_histogram() 

describe(residuals(mod_2)) # for skew and kurtosis

##=====================================================================================================================================================================================================##
#  Checking linearity
##=====================================================================================================================================================================================================##

mod_2 %>% residualPlots() 

##=====================================================================================================================================================================================================##
#  Checking homoscedasticity
##=====================================================================================================================================================================================================##

mod_2 %>% plot(which = 3)
mod_2 %>% ncvTest() # Non-constant Variance Score Test
mod_2 %>% bptest() # Breush-Pagan test 

##=====================================================================================================================================================================================================##
#  Checking multicollinearity
##=====================================================================================================================================================================================================##

mod_2 %>% vif() 
data_sample_1  %>% 
  select(pain, cortisol_serum, cortisol_saliva) %>% 
  pairs.panels(col = "red", lm = T)

##=====================================================================================================================================================================================================##
#  Building a new model without cortisol_saliva
##=====================================================================================================================================================================================================##

mod_final = lm(pain ~ age + sex + STAI_trait + pain_cat + mindfulness + cortisol_serum, data = data_sample_1)
mod_final %>% 
  summary()

##=====================================================================================================================================================================================================##
#  Running the same diagnostics on the final model
##=====================================================================================================================================================================================================##

#1 
mod_final %>% plot(which = 2) 

residuals_mod_final = enframe(residuals(mod_final))
residuals_mod_final %>%        
  ggplot() + aes(x = value) + 
  geom_histogram() 

describe(residuals(mod_2))

#2
mod_final %>% residualPlots() 

#3
mod_final %>% plot(which = 3)
mod_final %>% ncvTest() 
mod_final %>% bptest() 

#4
mod_final %>% vif()

##=====================================================================================================================================================================================================##
#  Model comparison
##=====================================================================================================================================================================================================##

AIC(mod_1)
coef_table(mod_1)

AIC(mod_final)
coef_table(mod_final)

anova(mod_1, mod_final)